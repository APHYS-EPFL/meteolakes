"use strict";PIXI.utils._saidHello=!0,angular.module("meteolakesApp",["rbush","stats","ngAnimate","ngRoute","ui.bootstrap.datetimepicker"]),angular.module("rbush",[]),angular.module("stats",[]),angular.module("meteolakesApp").config(["$locationProvider","$routeProvider",function(t,e){t.hashPrefix("!"),e.when("/hydro",{redirectTo:"/hydro/geneva"}).when("/hydro/:lakeId",{template:"<page-hydro></page-hydro>"}).when("/quality",{redirectTo:"/quality/geneva"}).when("/quality/:lakeId",{template:"<page-quality></page-quality>"}).when("/remote",{template:"<page-remote></page-remote>"}).when("/insitu",{template:"<page-insitu></page-insitu>"}).when("/about",{template:"<page-about></page-about>"}).when("/data",{template:"<page-data-form></page-data-form>"}).when("/info",{template:"<page-info></page-info>"}).otherwise("/hydro")}]),angular.module("meteolakesApp").directive("autoActive",["$location",function(t){return{restrict:"A",scope:!1,link:function(e,n){function a(){var e=t.path();e&&angular.forEach(n.find("li"),function(t){t.querySelector("a").href.match("#!"+e+"(?=\\?|$)")?angular.element(t).addClass("active"):angular.element(t).removeClass("active")})}a(),e.$on("$locationChangeSuccess",a)}}}]),angular.module("meteolakesApp").directive("colorLegend",function(){var t=0;return{restrict:"E",scope:{colors:"=",extent:"=",label:"="},link:function(e,n,a){var i=n[0],o="color-legend-gradient-"+ ++t,r=10,s=10,l=265-s-20,c=d3.select(i).append("svg").attr("width",265).attr("height",80),u=c.append("defs").append("linearGradient").attr("id",o).attr("x1","0%").attr("y1","100%").attr("x2","100%").attr("y2","100%").attr("spreadMethod","pad"),h=c.append("g").attr("transform","translate("+s+","+r+")");e.colors.forEach(function(t,n){var a=100*n/(e.colors.length-1);u.append("stop").attr("offset",a+"%").attr("stop-color",t).attr("stop-opacity",1)}),h.append("rect").attr("width",l).attr("height",20).style("fill","url(#"+o+")");var d=h.append("g").attr("class","chart-axis x").attr("transform","translate(0, 22)");d.append("text").attr("y",40).attr("dx",".71em").style("text-anchor","start").text(e.label),e.$watch("extent",function(t){if(t){var e=d3.scale.linear().range([0,l]).domain(t),n=d3.svg.axis().scale(e).ticks(4).orient("bottom");d.call(n)}})}}}),angular.module("meteolakesApp").directive("d3Chart",["$window",function(t){return{restrict:"E",scope:{setHandler:"&",data:"=",label:"=",placeholder:"=",onClose:"&"},link:function(e,n,a){var i,o,r=n[0],s=0,l=!1,c=d3.select(r).append("div");c.append("ol").attr("class","breadcrumb").append("li").attr("class","active").text(e.placeholder),e.$watch("placeholder",function(t,e){$(c[0][0]).children("ol").children("li").text(t)});var u=d3.select(r).append("div");u.append("div").attr("class","close").html("&times;").on("click",function(){e.onClose(),e.$apply()});var h={top:20,right:20,bottom:30,left:50},d=0,p=0,f=d3.time.scale(),m=d3.scale.linear(),v=d3.time.format.multi([["%H:%M",function(t){return t.getHours()||t.getMinutes()}],["%b %d",function(){return!0}]]),g=d3.svg.axis().scale(f).orient("bottom").tickFormat(v),y=d3.svg.axis().scale(m).orient("left"),x=d3.svg.area().interpolate("monotone").x(function(t){return f(t.date)||1}).y0(function(t){return m(t.max_value)}).y1(function(t){return m(t.min_value)}),b=d3.svg.line().interpolate("monotone").x(function(t){return f(t.date)}).y(function(t){return m(t.value)}),_=u.append("svg").style("width","100%"),w=_.append("g").attr("transform","translate("+h.left+","+h.top+")");function k(){if(i){n=T(),d=n-(h.left+h.right),p=.66*n-(h.top+h.bottom),f.range([0,d]),m.range([p,0]),g.ticks(d/80),y.ticks(p/50),_.style("height",p+h.top+h.bottom+"px");var t=l?_.transition():_;l=!0,t.select(".chart-axis.x").attr("transform","translate(0,"+p+")").call(g),t.select(".chart-axis.y").call(y),t.select(".chart-label").text(o).attr("transform","translate("+d/2+")"),i[0].min_value&&i[0].max_value?t.select(".chart-area").attr("d",x(i)):t.select(".chart-area").attr("d",null),t.select(".chart-line").attr("d",b(i));var e=f(i[s].date);t.select(".chart-vertical-line").attr("x1",e).attr("x2",e).attr("y1",0).attr("y2",p)}var n}function T(){return _.node().getBoundingClientRect().width}w.append("g").attr("class","chart-axis x"),w.append("g").attr("class","chart-axis y").append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text(e.label),w.append("text").attr("class","chart-label").attr("text-anchor","middle"),w.append("path").attr("class","chart-area"),w.append("path").attr("class","chart-line"),w.append("line").attr("class","chart-vertical-line"),e.setHandler({handler:function(t){s=t,k()}}),angular.element(t).bind("resize",function(){e.$apply()}),e.$watch(T,k),e.$watch("data",function(t,e){t?(e||(l=!1),i=t.data,o=t.z?"Location: "+t.x+" / "+t.y+" / "+d3.round(t.z,1)+" m":"Location: "+t.x+" / "+t.y+" m",f.domain(d3.extent(i,function(t){return t.date})),i[0].min_value&&i[0].max_value?m.domain([d3.min(i,function(t){return t.min_value}),d3.max(i,function(t){return t.max_value})]):m.domain(d3.extent(i,function(t){return t.value})),c.attr("class","hidden"),u.attr("class",null),k()):(c.attr("class",null),u.attr("class","hidden"))})}}}]),angular.module("meteolakesApp").directive("insituChart",["$window",function(t){return{restrict:"E",scope:{setHandler:"&",spec:"=",label:"@",onClose:"&"},link:function(e,n,a){var i,o=n[0],r=!1,s=d3.select(o).append("div"),l=.05,c={top:20,right:20,bottom:70,left:40},u=0,h=0,d=["#3366cc","#dc3912","#ff9900","#990099","#0099c6","#dd4477","#b82e2e","#316395","#994499","#22aa99"],p=40,f=d3.time.scale(),m=d3.scale.linear(),v=d3.time.format.multi([["%H:%M",function(t){return t.getHours()||t.getMinutes()}],["%b %d",function(){return!0}]]),g=d3.bisector(function(t){return t.date}).left,y=d3.format(",.1f"),x=d3.svg.axis().scale(f).orient("bottom").tickFormat(v),b=d3.svg.axis().scale(m).orient("left"),_=d3.svg.line().interpolate("monotone").x(function(t){return f(t.date)}).y(function(t){return m(t.value)});function w(){return d3.svg.axis().scale(f).orient("bottom").ticks(Math.max(u/100,2))}function k(){return d3.svg.axis().scale(m).orient("left").ticks(Math.max(h/50,4))}var T=s.append("svg").style("width","100%"),L=T.append("g").attr("transform","translate("+c.left+","+c.top+")");L.append("g").attr("class","chart-axis x"),L.append("g").attr("class","chart-axis y"),L.append("g").attr("class","grid x").attr("transform","translate("+c.left+","+c.top+")").call(w().tickSize(-h,0,0).tickFormat("")),L.append("g").attr("class","grid y").call(k().tickSize(-u,0,0).tickFormat(""));var M=L.append("text").attr("x",10).attr("y",6).attr("dy",".71em").text("[Unit]");function S(){if(i){var t=[],e=[];i.columns.forEach(function(n){var a=d3.extent(n.data,function(t){return t.date}),i=d3.extent(n.data,function(t){return t.value});t=t.concat(a),e=e.concat(i)}),t=d3.extent(t),e=d3.extent(e),f.domain(t);var n=l*(e[0]-e[1]);if(e[0]+=n,e[1]-=n,m.domain(e),function(){var t=D();t<720?(h=.75*t-(c.top+c.bottom),c.left=40):(h=.4*t-(c.top+c.bottom),c.left=50);L.attr("transform","translate("+c.left+","+c.top+")"),u=t-(c.left+c.right)}(),f.range([0,u]),m.range([h,0]),x.ticks(Math.max(u/100,2)),b.ticks(Math.max(h/50,4)),"unit"in i){M.text(i.unit);var a=function(t){return y(t)+" "+i.unit}}else{M.text(i.columns[0].unit);a=function(t){return y(t)+" "+i.columns[0].unit}}var o=r?L.transition():L;o.select(".chart-axis.x").attr("transform","translate(0,"+h+")").call(x),o.select(".chart-axis.y").call(b),o.select(".grid.x").attr("transform","translate(0,"+h+")").call(w().tickSize(-h,0,0).tickFormat("")),o.select(".grid.y").call(k().tickSize(-u,0,0).tickFormat(""));var s=d;i.columns.length>10&&(s=d3.scale.category20b().range());var v=10,S=h+c.bottom/2+10;o.selectAll(".chart-data").remove(),i.columns.forEach(function(n,a){"line"!==i.style&&"both"!==i.style||o.append("path").attr("class","chart-data chart-line").attr("d",_(n.data)).style("stroke",s[a]),"dots"!==i.style&&"both"!==i.style||n.data.forEach(function(t){o.append("line").attr("class","chart-data chart-circle").attr("x1",f(t.date)).attr("y1",m(t.value)).attr("x2",f(t.date)).attr("y2",m(t.value)).style("stroke",s[a])});d3.time.scale().domain(t).range([c.left,u-c.right]),d3.scale.linear().domain(e).range([c.top,h-c.bottom]);var r=o.append("text").attr("x",v).attr("y",S).attr("class","chart-data chart-legend").style("fill",s[a]).text(n.title),l=r[0][0].getBBox();v+l.width>u&&(S+=1.3*l.height,v=10,r.attr("x",v).attr("y",S)),v+=l.width+15});for(var P=[],A=[],C=0;C<i.columns.length;C++){var j=d[C%d.length],E=L.append("g");E.append("rect").attr("transform","translate(0,0)").style("fill",j),A.push(E);var I=L.append("g").attr("class","focus").style("display","none");I.append("circle").attr("r",4.5).style("stroke",j),I.append("text").attr("x",9).attr("dy","-0.35em"),P.push(I),L.append("rect").attr("class","overlay").attr("width",u).attr("height",h).on("mouseover",function(){A.forEach(t=>t.style("opacity",1)),P.forEach(t=>t.style("display",null))}).on("mouseout",function(){A.forEach(t=>t.style("opacity",0)),P.forEach(t=>t.style("display","none"))}).on("mousemove",$)}function $(){var t,e=f.invert(d3.mouse(this)[0]);i.columns.forEach(function(n,o){var r=n.data,s=g(r,e,1);if(r[s-1]&&r[s]){var l,c=e-r[s-1].date>r[s].date-e?s:s-1;l=f(r[i.columns[0].data.length-1].date)-f(r[c].date)<100?-104:8;var u=A[o],h=P[o],d=m(r[c].value),v=0;t?(d<t&&t-d<p&&(v=t-d,v=(d=t-p)-m(r[c].value)),d>t&&d-t<p&&(v=(d=t+p)-m(r[c].value))):t=d,h.attr("transform","translate("+f(r[c].date)+","+m(r[c].value)+")"),h.select("text").attr("x",l+1).attr("fill","white").attr("transform","translate(0,"+v+")").text(a(r[c].value)).append("svg:tspan").attr("x",l+1).attr("dy","1.35em").text(r[c].date.format("DD-MMM HH:mm")),u.select("rect").attr("x",f(r[c].date)+l).attr("y",d-17).attr("width",95).attr("height",35).style("opacity",.6)}})}c.bottom=S-h+20,T.style("height",h+c.top+c.bottom+"px")}}function D(){return T.node().getBoundingClientRect().width}L.append("path").attr("class","chart-data"),angular.element(t).bind("resize",function(){e.$apply()}),e.$watch(D,S),e.$watch("spec.columns[0].data",function(){"data"in e.spec.columns[0]&&(i=e.spec,S())})}}}]),angular.module("meteolakesApp").directive("lakeIcon",function(){return{restrict:"E",transclude:!0,scope:{src:"@",lat:"@",lng:"@",width:"@",height:"@",anchorLeft:"@",anchorTop:"@",popupLeft:"@",popupTop:"@"},require:"^^lakeView",template:"<div ng-transclude></div>",link:function(t,e,n,a){var i=e[0].children[0].innerHTML;e[0].children[0].remove();var o={src:t.src,lat:parseFloat(t.lat),lng:parseFloat(t.lng),width:parseInt(t.width,10),height:parseInt(t.height,10),anchorLeft:parseInt(t.anchorLeft,10),anchorTop:parseInt(t.anchorTop,10),popupLeft:parseInt(t.popupLeft,10),popupTop:parseInt(t.popupTop,10),popupText:i};a.addIcon(o)}}}),angular.module("meteolakesApp").directive("leafletMap",["CanvasLayer","ShowCoordinates","MapHelpers","$timeout",function(t,e,n,a){return{restrict:"E",scope:{active:"=",setHandler:"&",onClick:"&",marker:"=",data:"=",init:"=",draw:"="},link:function(t,e,i){e.addClass("lv-map");var o,r,s,l,c=function(t){L.Map.mergeOptions({touchExtend:!0}),L.Map.TouchExtend=L.Handler.extend({initialize:function(t){this._map=t,this._container=t._container,this._pane=t._panes.overlayPane},addHooks:function(){L.DomEvent.on(this._container,"touchstart",this._onTouchStart,this),L.DomEvent.on(this._container,"touchend",this._onTouchEnd,this)},removeHooks:function(){L.DomEvent.off(this._container,"touchstart",this._onTouchStart),L.DomEvent.off(this._container,"touchend",this._onTouchEnd)},_onTouchStart:function(t){if(this._map._loaded){var e=this._map.mouseEventToContainerPoint(t),n=this._map.containerPointToLayerPoint(e),a=this._map.layerPointToLatLng(n);this._map.fire("touchstart",{latlng:a,layerPoint:n,containerPoint:e,originalEvent:t})}},_onTouchEnd:function(t){this._map._loaded&&this._map.fire("touchend",{originalEvent:t})}}),L.Map.addInitHook("addHandler","touchExtend",L.Map.TouchExtend);var e=L.map(t);return L.tileLayer("https://{s}.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={access_token}",{subdomains:"abcd",maxZoom:18,attribution:'Map data &copy; <a href="https://openstreetmap.org">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://mapbox.com">Mapbox</a>',id:"mapbox.streets",access_token:"pk.eyJ1IjoiYXBoeXMiLCJhIjoiY2ltM2g1MzUwMDBwOXZtbTVzdnQ1ZHZpYiJ9.Cm1TVUsbCQLOhUbblOrHfw"}).addTo(e),e}(e[0]),u=L.canvasLayer({dataSource:"surface"});function h(){o&&c.fitBounds(o.pad(-.05))}"function"==typeof t.init&&t.init(c),u.addTo(c),L.control.showcoordinates({format:n.formatCoordinates}).addTo(c),t.setHandler({handler:function(){u.redraw()}}),t.$emit("mapLoaded",c),c.on("click",function(e){t.onClick({point:n.project(e.latlng),latLngToLayerPoint:c.latLngToLayerPoint}),t.$apply()}),c.on("touchstart",function(t){l=t.latlng,s=Date.now()}),c.on("touchend",function(){Date.now()-s<300&&(t.onClick({point:n.project(l),mapPoint:c.latLngToLayerPoint(l)}),t.$apply())}),t.$on("particleAdded",function(){u.redraw()}),u.setDrawFunction(t.draw),t.$watch("active",function(){t.active&&a(function(){c.invalidateSize(!1),h()})}),t.$watch("marker",function(e){if(t.active&&e){var a=n.unproject(e);r?r.setLatLng(a):r=L.marker(a).addTo(c)}else r&&(c.removeLayer(r),r=null)}),t.$watch("data.ready",function(){var e,a=t.data;if(a&&a.ready){var i=n.unproject(L.point(a.xExtent[0],a.yExtent[0])),r=n.unproject(L.point(a.xExtent[1],a.yExtent[1]));(e=L.latLngBounds(i,r)).equals(o)||(o=e,h());var s=a.map(function(t){var e=n.unproject(L.point(t.x,t.y));return{lat:e.lat,lng:e.lng,values:t.values}});u.setData(s)}})}}}]),angular.module("meteolakesApp").directive("loading",function(){return{restrict:"E",template:'<div class="loading"><div class="sk-folding-cube"><div class="sk-cube1 sk-cube"></div><div class="sk-cube2 sk-cube"></div><div class="sk-cube4 sk-cube"></div><div class="sk-cube3 sk-cube"></div> </div></div>'}}),angular.module("meteolakesApp").directive("pixiCanvas",["Util","$timeout",function(t,e){var n=L.CRS.Simple;function a(t){return n.projection.unproject(t)}return{restrict:"E",scope:{active:"=",setHandler:"&",onClick:"&",marker:"=",data:"=",draw:"=",source:"@",labelLeft:"=",labelRight:"=",mapImgSrc:"="},link:function(i,o,r){o.addClass("lv-map");var s,l,c,u=o[0],h=$("<img/>",{class:"lv-img-overlay",src:i.mapImgSrc});o.prepend(h),i.$watch("mapImgSrc",function(){o.children(".lv-img-overlay").attr("src",i.mapImgSrc)}),i.$watch("labelLeft",function(){i.active&&c&&l?l.left.setContent(i.labelLeft):c&&l&&(l.left.labelReady=!1)}),i.$watch("labelRight",function(){i.active&&c&&l?l.right.setContent(i.labelRight):c&&l&&(l.right.labelReady=!1)});var d,p,f,m=L.map(u,{crs:n,minZoom:-5,attributionControl:!1}),v=L.canvasLayer({background:!0,dataSource:i.source});function g(){i.active&&c&&(l?(l.left.labelReady||l.left.setContent(i.labelLeft),l.right.labelReady||l.right.setContent(i.labelRight),l.right.setLatLng(a(L.point(c,0)))):((l={left:y(L.point(0,0),i.labelLeft),right:y(L.point(c,0),i.labelRight)}).left.labelReady=!0,l.right.labelReady=!0))}function y(t,e){return L.popup({closeButton:!1,closeOnClick:!1,autoPan:!1}).setLatLng(a(t)).setContent(e).addTo(m)}L.control.attribution().addAttribution('© <a href="https://www.mapbox.com/about/maps/"">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>').addTo(m),v.addTo(m),i.setHandler({handler:function(){v.redraw()}}),m.on("click",function(e){if(p){var a=(s=e.latlng,n.projection.project(s));a.x/=.02;var o=t.closest(p,a.x,!0),r=t.closest(f,a.y,!0);i.data.Data[o][r]&&(i.onClick({point:{i:o,j:r}}),i.$apply())}var s}),v.setDrawFunction(i.draw),function(t){var e={top:10,right:60,bottom:20,left:60},n=d3.select(t.getPanes().overlayPane).append("svg"),a=n.append("g"),i=a.append("g").attr("class","chart-axis"),o=d3.scale.linear(),r=d3.svg.axis().scale(o).orient("right").tickFormat(function(t){return t+" m"});function s(){var s=t.containerPointToLayerPoint([0,0]);L.DomUtil.setPosition(n.node(),s);var l=t.getSize(),c=0,u=t.containerPointToLatLng([0,e.top]).lat;u>0&&(u=0,c=t.latLngToContainerPoint([0,0]).y-e.top);var h=l.y-e.top-e.bottom,d=t.containerPointToLatLng([0,e.top+h]).lat,p=h-c;n.attr("width",l.x).attr("height",l.y),a.attr("transform","translate("+(l.x-e.right)+","+e.top+")").style("visibility",p>0?"visible":"hidden"),o.range([c,h]),o.domain([u,d]),r.ticks(p/50),i.call(r)}t.on("move",s),t.on("viewreset",s)}(m),i.$watch("active",function(){i.active&&e(function(){m.invalidateSize(!1),s&&(m.fitBounds(s),g())})}),i.$watch("marker",function(t){if(i.active&&t){var e=i.data.Data[t.i][t.j],n=.02*p[t.i],o=e.z,r=a(L.point(n,o));d?d.setLatLng(r):d=L.marker(r).addTo(m)}else d&&(m.removeLayer(d),d=null)}),i.$watch("data.ready",function(){var e,n,o=i.data;if(o&&o.ready){p=[],f=[];var r,l,u=0,h=0;e=o.map(function(e,n,i){f[i]=e.z,n!==h&&(r&&(u+=t.norm([e.x-r,e.y-l])),p[n]=u,h=n,r=e.x,l=e.y);var o=.02*u,s=e.z,c=a(L.point(o,s));return{lat:c.lat,lng:c.lng,values:e.values}}),c=.02*u;var d=a(L.point(0,o.zExtent[0])),y=a(L.point(c,o.zExtent[1]+5));(n=L.latLngBounds(d,y)).equals(s)||(s=n,m.fitBounds(s)),g()}s&&v.setData(e)})}}}]),angular.module("meteolakesApp").component("pageAbout",{templateUrl:"app/page-about/page-about.template.html",controller:function(){}}),angular.module("meteolakesApp").component("lakeView",{templateUrl:"app/lake-view/lake-view.template.html",transclude:!0,bindings:{var:"@",legendVar:"@",type:"@",hasTransects:"@",lakeId:"<",maxExtentValue:"<",maxExtentForceValue:"<",minExtentValue:"<",minExtentForceValue:"<"},controller:["$scope","$q","Time","TemporalData","NearestNeighbor","Util","MapHelpers",function(t,e,n,a,i,o,r){var s=[],l=null,c=[],u=["surface"],h=this,d=[],p={},f=[],m=0,v=null,g=n.tIndex,y=!1;function x(){function t(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return t()+t()+"-"+t()+"-"+t()+"-"+t()+"-"+t()+t()+t()}function b(t,e){return Math.floor(Math.random()*(e-t))+t}function _(t,e,n,a,i,o,r){var s=Math.sqrt(n*n+a*a);if(s>.001){var l=t,c=e,u=n*w(s,r),h=a*w(s,r),d=t+u,p=e+h,f=Math.sqrt(u*u+h*h),m=f/5>2?f/5:2,v=Math.atan2(h,u);o.lineStyle(1+5*s,+i.replace("#","0x")),o.moveTo(l,c),o.lineTo(d,p),o.lineTo(d-m*Math.cos(v-Math.PI/6),p-m*Math.sin(v-Math.PI/6)),o.moveTo(d,p),o.lineTo(d-m*Math.cos(v+Math.PI/6),p-m*Math.sin(v+Math.PI/6))}}function w(t,e){var n=30*(-1/(t/e+1)+1)*2;return n<5?5/t:n/t}function k(){var t=h.tab;"particles"===h.tab&&(t="surface");var e=h[t+"Data"];if(e.available||"surface"===t){var n=0;e.getLakeOptions().then(function(t){h.options=t,n=T(n,e)}),e.getGlobalOptions().then(function(t){h.global=t,n=T(n,e)}),e.readData().then(function(){var a=0,r=e.scaleExtent;h.minExtentValue&&r[0]<h.minExtentValue&&(a=h.minExtentValue-r[0],r[0]=h.minExtentValue,r[1]<h.minExtentValue&&(r[1]=h.minExtentValue+a)),h.minExtentForceValue&&(a=h.minExtentForceValue-r[0],r[0]=h.minExtentForceValue,r[1]<h.minExtentForceValue&&(r[1]=h.minExtentForceValue+a)),h.maxExtentValue&&r[1]>h.maxExtentValue&&(r[1]=h.maxExtentValue),h.maxExtentForceValue&&(r[1]=h.maxExtentForceValue),s[t]=function(t){var e=t[0],n=t[1],a=h.legendColors.map(function(t,a){return e+a/(h.legendColors.length-1)*(n-e)});if("vector"===h.type)return function(t){var e=d3.scale.linear().domain(a).range(h.legendColors);return e(o.norm(t))};return d3.scale.linear().domain(a).range(h.legendColors)}(r),"surface"===t&&(l=i(h.surfaceData)),h[t+"Extent"]=r,n=T(n,e)})}else h.setTab("surface")}function T(e,n){return 3===++e&&(h.dataReady=!0,t.$emit("dataReady",n.timeSteps)),e}function M(t,e){var n=t[e];if(n&&!function(t){return h.options.outlets.some(function(e){return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2))<e.r})}(n)){var a=h.surfaceData,i=l.query(n),o=a.Data[i.i][i.j].values[e],r=n.x+3600*o[0]*3,s=n.y+3600*o[1]*3;t[parseInt(e,10)+1]={x:r,y:s}}}function S(t){for(var e=n.tIndex;e<n.nSteps;e++)M(t,e)}h.tab="surface",h.dataReady=!1,h.timeSelection=null,h.vectorLabel="Depth Averaged",h.valueLabel="Surface","value"===h.type?(h.surfaceData=new a(h.var,.03),h.legendColors=["blue","cyan","lime","yellow","red"],"true"===h.hasTransects?(h.sliceXZData=new a(h.var,0,"slice_xz"),h.sliceYZData=new a(h.var,0,"slice_yz"),u=["surface","sliceXZ","sliceYZ"]):(h.sliceXZData=null,h.sliceYZData=null)):"vector"===h.type?(h.surfaceData=new a(h.var),h.surfaceData.setValueAccessor(o.norm),h.particlesData=new a(h.var),h.particlesData.setValueAccessor(o.norm),h.legendColors=["blue","lime","red"],u=["surface","particles"]):"valueWAQoxygen"===h.type?(h.surfaceData=new a(h.var,.03),h.legendColors=["black","red","yellow","cyan","blue"],"true"===h.hasTransects?(h.sliceXZData=new a(h.var,0,"slice_xz"),h.sliceYZData=new a(h.var,0,"slice_yz"),u=["surface","sliceXZ","sliceYZ"]):(h.sliceXZData=null,h.sliceYZData=null)):"valueWAQchlfa"===h.type&&(h.surfaceData=new a(h.var,.03),h.legendColors=["blue","cyan","lightgreen","green"],"true"===h.hasTransects?(h.sliceXZData=new a(h.var,0,"slice_xz"),h.sliceYZData=new a(h.var,0,"slice_yz"),u=["surface","sliceXZ","sliceYZ"]):(h.sliceXZData=null,h.sliceYZData=null)),t.$emit("registerClient"),t.$on("updateTimeSelection",function(t,e){s={},h.dataReady=!1,h.timeSelection=e,null!==e.depth?(h.vectorLabel="Layer "+Math.abs(e.depth)+" m",h.valueLabel="Layer "+Math.abs(e.depth)+" m"):(h.vectorLabel="Depth Averaged",h.valueLabel="Surface"),h.closeChart(),y?(f.forEach(function(t){var e=p[t][p[t].length-1];p[t]=[],p[t][0]=e,S(p[t])}),y=!1):(f=[],p=[]),u.forEach(function(t){h[t+"Data"].setTimeSelection(e).then(function(){t===h.tab&&k()})})}),t.$on("timerPaused",function(){y=!1}),t.$on("tick",function(){c.forEach(function(t){t(n.tIndex)}),"particles"===h.tab&&g===n.nSteps-1&&(y=!0,t.$emit("moveToNextWeek"));g=n.tIndex%n.nSteps}),t.$watch("$ctrl.chartPoint",function(t){if(t){var e=h[h.tab+"Data"],n=e.Data[t.i][t.j];if(h.timeSelection.needNetcdf)e.getDataAtPoint(n).then(function(t){h.chartData={x:n.x,y:n.y,z:"surface"===h.tab?h.timeSelection.depth:n.z,data:t}});else{var a=n.values.map(o.norm);h.chartData={x:n.x,y:n.y,data:e.withTimeSteps(a)}}}else h.chartData=null}),t.$on("mapLoaded",function(t,e){v=e}),t.$on("dataReady",function(){f.forEach(function(t){S(p[t])})}),h.addAnimationHandler=function(t){c.push(t)},h.closeChart=function(){h.chartPoint=null},h.initMap=function(t){d.forEach(function(e){var n=L.icon({iconUrl:e.src,iconSize:[e.width,e.height],iconAnchor:[e.anchorLeft,e.anchorTop],popupAnchor:[e.popupLeft,e.popupTop]});L.marker({lat:e.lat,lng:e.lng},{icon:n}).addTo(t).bindPopup(e.popupText)})},h.addIcon=function(t){d.push(t)},h.drawOverlay=function(t,e){return h.dataReady?"vector"===h.type?function(t,e){var a,i,o,c,u,d,m,g,y=s[e.dataSource],x=e.size,b=new L.Bounds(L.point([-30,-30]),x.add([30,30])),w=[],k=0;for(u=0,i=t.length;u<i;u++){var T=t[u];for(d=0;d<T.length;d++)if((c=T[d])&&b.contains(c.p)){m=Math.floor(c.p.x/15)+2,g=Math.floor(c.p.y/15)+2;for(var M=c.values[n.tIndex],S=0;S<c.values.length;S++){var D=Math.sqrt(c.values[S][0]*c.values[S][0]+c.values[S][1]*c.values[S][1]);D>k&&(k=D)}w[g]=w[g]||[],(a=w[g][m])?(a[0]+=c.p.x,a[1]+=c.p.y,a[2]+=M[0],a[3]+=M[1],a[4]++):w[g][m]=[c.p.x,c.p.y,M[0],M[1],1]}}var P=new PIXI.Graphics;for(u=0,i=w.length;u<i;u++)if(w[u])for(d=0,o=w[u].length;d<o;d++)if(a=w[u][d]){m=a[0]/a[4],g=a[1]/a[4];var A=a[2]/a[4],C=a[3]/a[4],j=y([A,C]);_(m,g,A,-C,j,P,k)}return P.lineStyle(h.global.particleLineThickness,h.global.particleLineColor),f.forEach(function(t){var e=p[t][n.tIndex];e&&function(t,e){var n=t,a=l.query(n);(Math.abs(a.x-n.x)>h.options.maxDistToNeighbour||Math.abs(a.y-n.y)>h.options.maxDistToNeighbour)&&(n=a);var i=function(t){var e=r.unproject(t);return v.latLngToContainerPoint(e)}(n);e.beginFill(h.global.particleFillColor),e.drawCircle(i.x,i.y,h.global.particleSize),e.endFill()}(e,P)}),P}(t,e):function(t,e){var a=s[e.dataSource],i=e.size,o=new PIXI.Graphics;if(!a||h.tab!==e.dataSource)return o;if(e.background){var r=e.project([0,0]);o.beginFill(4620980),o.drawRect(0,0,i.x,r.y),o.endFill(),o.beginFill(9006675),o.drawRect(0,r.y,i.x,i.y),o.endFill()}for(var l=new L.Bounds(L.point([0,0]),i),c=0;c<t.length-1;c++)for(var u=t[c],d=t[c+1],p=0;p<u.length-1;p++){var f=[u[p],u[p+1],d[p],d[p+1]];if(f.every(function(t){return t})&&f.some(function(t){return l.contains(t.p)})){var m=a(u[p].values[n.tIndex]),v=f[0].p,g=f[1].p,y=f[2].p,x=f[3].p;o.beginFill(+m.replace("#","0x")),o.moveTo(v.x,v.y),o.lineTo(g.x,g.y),o.lineTo(x.x,x.y),o.lineTo(y.x,y.y),o.endFill()}}return o}(t,e):new PIXI.Graphics},h.addParticles=function(e){var a=Date.now()-m;if(m=Date.now(),a>50){for(var i=0;i<h.global.particleAddedOnClick;i++){var o=b(e.x-h.options.insertRadius,e.x+h.options.insertRadius),r=b(e.y-h.options.insertRadius,e.y+h.options.insertRadius),s=x();f.push(s),p[s]=[],p[s][n.tIndex]={x:o,y:r},S(p[s])}t.$broadcast("particleAdded")}},h.mapClicked=function(t){h.chartPoint=l.query(t)},h.sliceClicked=function(t){h.chartPoint=t},h.setTab=function(e){h.closeChart(),p={},f=[],h.tab=e,t.$emit("tabChanged"),h.dataReady=!1,k()}}]}),angular.module("meteolakesApp").controller("TimeCtrl",["$scope","$interval","$location","Time","DateHelpers","DataIndex","Util",function(t,e,n,a,i,o,r){function s(e,n){o.load(t.availabilityFile).then(function(a){t.index=a,t.netcdfAvailabilityFile&&n?o.loadNetcdf(t.netcdfAvailabilityFile).then(function(n){t.netcdfIndex=n,l(e)}):l(e)},function(t){console.error("Failed to load data index!",t)})}function l(e){m=!0;var a=moment();t.selection={year:a.year(),week:a.isoWeek(),depth:null};let i=0;var o,s;e&&-1===(i=t.index.findIndex(t=>{return("data"===t.folder?"geneva":t.folder.slice(5))===e}))&&(n.path(n.path().replace(e,"")),i=0),o=i,s=t.index[o],t.selection.lake=o,t.selection.folder=s.folder,t.selection.interval=s.interval,function(){var e=t.index[t.selection.lake];t.selection.year=r.closest(e.years,t.selection.year)}(),y(),x()}t.init=function(e,n,a){t.availabilityFile=e,t.netcdfAvailabilityFile=n;var i=this;o.apiStatus().then(function(t){i.apiAvailable=!0,s(a,i.apiAvailable)},function(t){i.apiAvailable=!1,s(a,i.apiAvailable)})};var c=50,u=800,h=400,d=null,p=[],f=!1,m=!1;t.clientsKnown=0,t.clientsReady=0;var v=!0;function g(){return t.clientsReady===t.clientsKnown&&t.clientsKnown>0}function y(){var e=t.index[t.selection.lake];t.selection.week=r.closest(e.data.get(t.selection.year),t.selection.week)}function x(){t.hasDepthList()?t.ChangeDepth(t.netcdfIndex[t.selection.lake].depths[0]):(t.selection.depth=null,t.selection.needNetcdf=!1)}function b(){t.hasDepthList()&&-1!==t.netcdfIndex[t.selection.lake].depths.indexOf(-t.selection.depth)||x()}function _(){d&&(e.cancel(d),d=e(k,h))}function w(){$(".lv-faster").prop("disabled",h===c),$(".lv-slower").prop("disabled",h===u)}function k(){a.increase(!0)}function T(){return p[a.tIndex]}function L(t,e){var n,a=NaN,i=1/0;for(n=0;n<e.length;++n){var o=Math.abs(e[n]-t);o<i&&(a=n,i=o)}return a}function M(){var e=$("input[type='range']"),n=e.position(),i=(L(moment(),p)+1)/a.nSteps;t.selection.week==moment().isoWeek()&&(e.next("bubble.large").css({left:i*e.width()+"px",marginLeft:n.left-25+"px",visibility:"visible",opacity:.82,cursor:"pointer"}),e.next("bubble.xs").css({left:i*(window.innerWidth-90)+"px",marginLeft:n.left-3+"px",visibility:"visible",opacity:.82,cursor:"pointer"}))}t.playTimeout,t.isPlaying=!1,t.selection={},t.$watch("selection",function(e){m&&(v=t.isPlaying||v,t.stop(),t.clientsReady=0,t.$broadcast("updateTimeSelection",e))},!0),t.$watch("Time.tIndex",function(){t.$broadcast("tick")}),t.$on("tabChanged",function(){v=t.isPlaying||v,t.pause(),t.clientsReady--}),t.$on("registerClient",function(){t.clientsKnown++}),t.$on("dataReady",function(e,n){p=n,a.nSteps=p.length,t.clientsReady++,function(){if(g()){!function(t){var e=L(moment(),p)+1;1==e&&(e=0);var n=e/a.nSteps;$(t).css("background-image","-webkit-gradient(linear, left top, right top, color-stop("+n+", #989898), color-stop("+n+", #ADD8E6))")}('input[type="range"]');var e=moment();if(t.selection.week==e.isoWeek()&&t.selection.year==e.year()){var n=L(e,p);a.tIndex=n,setTimeout(function(){M()},1e3),t.playTimeout=setTimeout(function(){v&&!t.isPlaying&&(v=!1,t.play())},5e3)}else(i=$("input[type='range']")).next("bubble.large").css({visibility:"hidden",opacity:0}),i.next("bubble.xs").css({visibility:"hidden",opacity:0}),v&&!t.isPlaying&&(v=!1,t.play())}var i}()}),t.Time=a,t.play=function(){t.isPlaying=!0,f=!1,null==d?d=e(k,h):t.pause()},t.pause=function(){t.isPlaying=!1,e.cancel(d),d=null},t.backward=function(){a.decrease()},t.forward=function(){a.increase(!1)},t.slower=function(){h<u&&(h*=2),_(),w()},t.faster=function(){h>c&&(h/=2),_(),w()},t.stop=function(){t.pause();var e=moment();if(t.selection.week==e.isoWeek()&&t.selection.year==e.year()){var n=L(e,p);a.tIndex=n}else a.tIndex=0},t.getDate=function(){return g()?i.dayMonthYear(T()):""},t.getTime=function(){return g()?i.hoursMinutes(T()):""},t.PrettyPrintWeek=function(e){var n=i.firstDayOfWeek(e,t.selection.year),a=i.lastDayOfWeek(e,t.selection.year);return"Week "+e+" ("+(i.yearMonthDay(n)+" - "+i.yearMonthDay(a))+")"},t.PrettyPrintDepth=function(t){return t?Math.abs(t).toString()+" m":""},t.ChangeWeek=function(e){t.selection.week=e,b()},t.ChangeYear=function(e){t.selection.year=e,y(),b()},t.ChangeLake=function(e){let a=t.index[e],i="data"===a.folder?"geneva":a.folder.slice(5),o=n.path().match(/(\/[^\/]+)/);o&&n.path(`${o[1]}/${i}`)},t.ChangeDepth=function(e){t.selection.depth=Math.abs(e),t.selection.needNetcdf=!0},t.hasDepthList=function(){return this.apiAvailable&&t.netcdfIndex&&t.netcdfIndex[t.selection.lake]&&t.netcdfIndex[t.selection.lake].data.get(t.selection.year)&&t.netcdfIndex[t.selection.lake].data.get(t.selection.year).includes(t.selection.week)},t.$on("$destroy",function(){d&&e.cancel(d)}),t.$on("moveToNextWeek",function(){var e=t.selection.week,n=t.selection.year,i=moment().day("Monday").year(n).week(e);i.add(1,"w");var o=t.index[t.selection.lake],s=r.closest(o.years,i.year()),l=r.closest(o.data.get(i.year()),i.week());n===s&&e===l?f||(t.pause(),a.moveToEnd(),t.$emit("timerPaused"),f=!0):(t.selection.week=l,t.selection.year=s)}),t.bubbleClick=function(){t.stop()},window.addEventListener("resize",M),t.$on("$locationChangeSuccess",function(){clearTimeout(t.playTimeout),t.pause(),v=!1})}]),angular.module("meteolakesApp").component("pageDataForm",{templateUrl:"app/page-data-form/page-data-form.template.html",controller:["$scope","NETCDF_DATA_HOST",function(t,e){this.hostname=e,t.onSetTime=function(e,n){var a=e.getFullYear(),i=e.getMonth(),o=e.getDate(),r=e.getHours();t.result=new Date(Date.UTC(a,i,o,r))}}]}),angular.module("meteolakesApp").component("pageHydro",{templateUrl:"app/page-hydro/page-hydro.template.html",controller:["$scope","$routeParams",function(t,e){t.lakeId=e.lakeId}]}),angular.module("meteolakesApp").component("pageQuality",{templateUrl:"app/page-quality/page-quality.template.html",controller:["$scope","$routeParams",function(t,e){t.lakeId=e.lakeId}]}),angular.module("meteolakesApp").component("pageInfo",{templateUrl:"app/page-info/page-info.template.html",controller:function(){}}),angular.module("meteolakesApp").controller("GraphCtrl",["$scope","$q","Util","InsituDataIndex","PlotIndex",function(t,e,n,a,i){var o=!1;e.all([a.load(),i.load()]).then(function(){t.years=Object.keys(a.dataPeriods),t.plots=i.plots;var e=moment().subtract(7,"days");t.selection={period:7,month:e.month(),day:e.date(),year:e.year()},o=!0,t.ChangeYear(t.selection.year)},function(t){console.error("Failed to load data and plot index!",t)}),t.$watch("selection",function(e){o&&i.loadPlotData(t.selectionMoment(),t.selection.period)},!0),t.AlphaMonth=function(t,e){if(o){var n=moment({month:t});return e?n.format("MMM"):n.format("MMMM")}return"Loading..."},t.AlphaPeriod=function(t){return o?t+" day"+(1===t?"":"s"):"..."},t.ChangeDay=function(e){t.selection.day=e},t.ChangeMonth=function(e){t.selection.month=e;var a=moment({month:e}).daysInMonth();t.days=[];for(var i=1;i<=a;i++)(t.selection.year<moment().year()||e<moment().month()||i<=moment().date())&&t.days.push(i);t.ChangeDay(n.closest(t.days,t.selection.day,!1))},t.ChangeYear=function(e){o&&(t.selection.year=e,t.months=a.dataPeriods[e],t.ChangeMonth(n.closest(t.months,t.selection.month,!1)))},t.ChangePeriod=function(e){t.selection.period=e},t.selectionMoment=function(){var e=t.selection;return moment({year:e.year,month:e.month,day:e.day})}}]),angular.module("meteolakesApp").component("pageInsitu",{templateUrl:"app/page-insitu/page-insitu.template.html",controller:function(){}}),angular.module("meteolakesApp").component("pageRemote",{templateUrl:"app/page-remote/page-remote.template.html",bindings:{scale:"<"},controller:["$window","$scope",function(t,e){var n=this,a=!1;function i(){n.scale=Math.min(.8,$(".iframe-container")[0].clientWidth/1900)}i(),angular.element(t).bind("resize",function(){i(),e.$apply()}),n.onClick=function(){(a=!a)?n.scale=.8:i()}}]}),angular.module("meteolakesApp").service("CanvasLayer",function(){L.CanvasLayer=(L.Layer?L.Layer:L.Class).extend({initialize:function(t){this._dragging=!1,L.setOptions(this,t)},setData:function(t){return this._data=t,this._reset()},setDrawFunction:function(t){this._drawFunction=t},redraw:function(){return!this._canvas||this._frame||this._dragging||(this._frame=L.Util.requestAnimFrame(this._redraw,this)),this},onAdd:function(t){this._map=t,this._canvas||this._initCanvas(),t._panes.overlayPane.appendChild(this._canvas),t.on("moveend",this._reset,this);var e=this;t.on("dragstart",function(){e._dragging=!0}),t.on("dragend",function(){e._dragging=!1}),t.options.zoomAnimation&&L.Browser.any3d&&t.on("zoomanim",this._animateZoom,this),this._reset()},onRemove:function(t){t.getPanes().overlayPane.removeChild(this._canvas),t.off("moveend",this._reset,this),t.options.zoomAnimation&&t.off("zoomanim",this._animateZoom,this)},addTo:function(t){return t.addLayer(this),this},_initCanvas:function(){var t=this._map.getSize();this._container=new PIXI.Container,this._renderer=PIXI.autoDetectRenderer(t.x,t.y,{transparent:!0,antialias:!0}),this._canvas=this._renderer.view;var e=this._map.options.zoomAnimation&&L.Browser.any3d;L.DomUtil.addClass(this._canvas,"leaflet-canvas-layer"),L.DomUtil.addClass(this._canvas,"leaflet-zoom-"+(e?"animated":"hide"))},_reset:function(){var t=this._map.containerPointToLayerPoint([0,0]);L.DomUtil.setPosition(this._canvas,t);var e=this._map.getSize();this._renderer.resize(e.x,e.y),this._updateLatLngToPixel(),this._redraw()},_updateLatLngToPixel:function(){if(this._data)for(var t=0;t<this._data.length;t++)for(var e=this._data[t],n=0;n<e.length;n++){var a=e[n];a&&(a.p=this._map.latLngToContainerPoint([a.lat,a.lng]))}},_redraw:function(){for(var t=this,e=this._container.children.length-1;e>=0;e--)this._container.removeChild(this._container.children[e]);if(this._data&&this._drawFunction){var n={size:this._map.getSize(),background:this.options.background,dataSource:this.options.dataSource,project:function(e){return t._map.latLngToContainerPoint(e)}};this._container.addChild(this._drawFunction(this._data,n))}this._renderer.render(this._container),this._frame=null},_width:function(){return this._canvas.width},_height:function(){return this._canvas.height},_animateZoom:function(t){var e=this._map.getZoomScale(t.zoom),n=this._map._getCenterOffset(t.center)._multiplyBy(-e).subtract(this._map._getMapPanePos());L.DomUtil.setTransform?L.DomUtil.setTransform(this._canvas,n,e):this._canvas.style[L.DomUtil.TRANSFORM]=L.DomUtil.getTranslateString(n)+" scale("+e+")"}}),L.canvasLayer=function(t){return new L.CanvasLayer(t)}}),angular.module("meteolakesApp").constant("DATA_HOST","http://meteolakes.ch/meteolac/"),angular.module("meteolakesApp").constant("NETCDF_DATA_HOST","http://aphyspc18.epfl.ch/api"),angular.module("meteolakesApp").constant("DATA_WEATHER_STATION","campbell_buchillon"),angular.module("meteolakesApp").constant("DATA_WEATHER_FILEEXT",".dat"),angular.module("meteolakesApp").factory("DataFile",["DATA_HOST","DATA_WEATHER_STATION","DATA_WEATHER_FILEEXT","$q",function(t,e,n,a){var i=function(t,e,n){this.ready=!1,this.loading=!1,this.series=t,this.year=e,this.month=n,this.period=moment({year:e,month:n}).format("YYYY-MM"),this.data=[],this.units={}};return i.prototype.readData=function(){var i=this;return i.ready=!1,i.loading=!0,a(function(a,o){var r=i.getFileURL();d3.text(r,function(s,l){s?o("File not found: "+r):(i.data=i.parseCSV(l),i.year===moment().year()&&i.month===moment().month()?(r=t+e+"/"+i.series+n,d3.text(r,function(t,e){s?o("File not found: "+r):(i.data=i.data.concat(i.parseCSV(e)),i.ready=!0,i.loading=!1,a())})):(i.ready=!0,i.loading=!1,a()))})})},i.prototype.parseCSV=function(t){var e=this;t=t.substring(t.indexOf("\n")+1);var n=d3.csv.parse(t,function(t){return t.date=e.parseDate(t.TIMESTAMP),delete t.TIMESTAMP,t});return e.units=n.shift(),n.shift(),n},i.prototype.getFileURL=function(){return t+e+"/"+this.year+"/"+this.series+"_"+this.period+n},i.prototype.parseDate=function(t){return moment(t,"YYYY-MM-DD HH:mm:ss")},i}]),angular.module("meteolakesApp").service("DataIndex",["$q","DATA_HOST","NETCDF_DATA_HOST","DateHelpers",function(t,e,n,a){function i(n){return t(function(t,a){d3.json(e+n+".json",function(e,n){e?a(e):t(n)})})}function o(e){return t(function(t,n){t(e.map(function(t){var e=t.name;if("string"!=typeof e)return n("invalid name"),null;var a=t.folder;if("string"!=typeof a)return n("invalid folder"),null;var i=t.interval;if(isNaN(i))return n("invalid interval"),null;var o=s(t.data);if(!o)return n("invalid data"),null;var r=o.keys().sort();return{name:e,folder:a,interval:i,data:o,years:r}}))})}function r(e){return t(function(t,n){t(e.map(function(t){var e=t.name;if("string"!=typeof e)return n("invalid name"),null;var a=s(t.data);if(!a)return n("invalid data"),null;var i=a.keys().sort(),o=t.depths;return o?{name:e,data:a,years:i,depths:o}:(n("invalid depths"),null)}))})}function s(t){if(!t)return null;var e=d3.map();return Object.keys(t).forEach(function(n){var a=+n.substring(1);e.set(a,t[n])}),e}this.load=function(t){return i(t).then(o)},this.loadNetcdf=function(t){return i(t).then(r)},this.apiStatus=function(){let e=`${n}/status`;return t(function(t,n){d3.text(e,function(e,a){e?n(e):t(a)})})}}]),angular.module("meteolakesApp").service("DateHelpers",function(){this.firstDayOfWeek=function(t,e){return moment().year(e).isoWeek(t).startOf("isoWeek")},this.lastDayOfWeek=function(t,e){return moment().year(e).isoWeek(t).endOf("isoWeek")},this.numberOfWeeks=function(t){return moment().year(t).isoWeeksInYear()},this.yearMonthDay=function(t){return t.format("DD-MMM-YYYY")},this.dayMonthYear=function(t){return t.format("DD-MMM-YYYY")},this.hoursMinutes=function(t){return t.format("HH:mm")}}),angular.module("meteolakesApp").service("InsituDataIndex",["$q","DATA_HOST","DATA_WEATHER_STATION","DataFile",function(t,e,n,a){this.dataSeries={},this.dataPeriods={},this.availableData={},this.load=function(){var a=this;return t(function(t,i){d3.json(e+n+"/available_data.json",function(e,n){e?i(e):(a.availableData=n,a.parse(),t())})})},this.parse=function(){var t=this;Object.keys(t.availableData).forEach(function(e){var n=t.availableData[e],i=n.columns.map(function(t){return"string"!=typeof t?null:t});n.columns=i,n.dataFiles={},n.data.forEach(function(n){var i=moment(n,"YYYY-MM");void 0===t.dataPeriods[i.year()]&&(t.dataPeriods[i.year()]=[]),-1===t.dataPeriods[i.year()].indexOf(i.month())&&t.dataPeriods[i.year()].push(i.month()),t.availableData[e].dataFiles[n]=new a(e,i.year(),i.month())})})},this.getFilesByColumn=function(t,e,n){var a=this,i=e.clone(),o=[];do{Object.keys(a.availableData).forEach(function(e){if(-1!==a.availableData[e].columns.indexOf(t)){var n=i.format("YYYY-MM");if(n in a.availableData[e].dataFiles){var r=a.availableData[e].dataFiles[n];o.push(r)}}}),i.add(1,"month")}while(i.year()<n.year()||i.year()===n.year()&&i.month()<=n.month());return o}}]),angular.module("meteolakesApp").service("MapHelpers",function(){var t=L.point(42e4,35e4),e=L.point(9e5,3e4),n=new L.Proj.CRS("EPSG:21781","+proj=somerc +lat_0=46.95240555555556 +lon_0=7.439583333333333 +k_0=1 +x_0=600000 +y_0=200000 +ellps=bessel +towgs84=674.374,15.056,405.346,0,0,0,0 +units=m +no_defs",{resolutions:[4e3,3750,3500,3250,3e3,2750,2500,2250,2e3,1750,1500,1250,1e3,750,650,500,250,100,50,20,10,5,2.5],origin:[t.x,t.y]}),a=L.latLngBounds(o(t),o(e));function i(t){return n.projection.project(t)}function o(t){return n.projection.unproject(t)}this.project=i,this.unproject=o,this.formatCoordinates=function(t){if(a.contains(t)){var e=i(t);return Math.round(e.x)+", "+Math.round(e.y)}return""}}),angular.module("meteolakesApp").factory("NearestNeighbor",["rbush","knn",function(t,e){return function(n){var a=[];n.map(function(t,e,n){a.push({x:t.x,y:t.y,i:e,j:n})});var i=t(9,[".x",".y",".x",".y"]);return i.load(a),{query:function(t){return e(i,[t.x,t.y],1)[0]}}}}]),angular.module("meteolakesApp").service("PlotIndex",["$q","DATA_HOST","DATA_WEATHER_STATION","InsituDataIndex",function(t,e,n,a){this.plots=[],this.load=function(){var a=this;return t(function(t,i){d3.json(e+n+"/plots.json",function(e,n){e?i(e):(a.plots=n,a.parse(),t())})})},this.parse=function(){},this.loadPlotData=function(e,n){var i=this,o=[],r=[],s=e.clone().add(n,"days").endOf("day"),l=new Set;i.plots.forEach(function(t){t.columns.forEach(function(t){var n=a.getFilesByColumn(t.name,e,s);n.forEach(function(t){l.add(t)}),t.files=n.map(function(t){return t.series})})}),l.forEach(function(t){if(!t.loading&&!t.ready){var e=t.readData();o.push(e)}});var c=t.all(o).then(function(){i.plots.forEach(function(t){t.columns.forEach(function(t){var n=[];l.forEach(function(e){t.files.includes(e.series)&&n.push(e)}),n.sort(function(t,e){return t.data[0].date>e.data[e.data.length-1].date?1:e.data[0].date>t.data[t.data.length-1].date?-1:0}),t.data=[],n.forEach(function(n){n.data.forEach(function(a,i){var o=a[t.name];isFinite(o)&&""!==o?a.date>=e&&a.date<=s&&t.data.push({date:a.date,value:parseFloat(o)}):console.warn('Invalid number: "'+o+'" in file "'+n.getFileURL()+'", line '+(i+1)+', column "'+t.name+'"')})}),n.length>0&&(t.unit=n[0].units[t.name])}),r.push(c)})});return t.all(r)}}]),angular.module("meteolakesApp").service("ShowCoordinates",function(){L.Control.ShowCoordinates=L.Control.extend({options:{position:"bottomleft",format:function(t){return t}},initialize:function(t){L.setOptions(this,t)},onAdd:function(t){return this._container=L.DomUtil.create("div","leaflet-control-attribution"),t.on("mousemove",this._update,this),this._container},onRemove:function(t){t.off("mousemove",this._update,this)},_update:function(t){var e=t.latlng;e&&(this._container.innerHTML=this.options.format(e))}}),L.control.showcoordinates=function(t){return new L.Control.ShowCoordinates(t)}}),angular.module("meteolakesApp").factory("TemporalData",["DATA_HOST","NETCDF_DATA_HOST","$q","DateHelpers","stats","Util",function(t,e,n,a,i,o){var r=function(t,e,n){this.fieldName=t,this.suffix=n||"",this.timeSteps=[],this.Data=[],this.ready=!1,this.available=!1,this.valueAccessor=function(t){return t},this.cropPercentile=e||0,this.config=null,this.timeSelection=null};return r.prototype.setValueAccessor=function(t){this.valueAccessor=t},r.prototype.map=function(t){return this.Data.map(function(e,n){return e.map(function(e,a){return e?t(e,n,a):null})})},r.prototype.setTimeSelection=function(t){var e=this;e.timeSelection=t;var a=e.getValuesFile(!0);return e.ready=!1,n(function(t){d3.json(a+".json",function(n,a){n?(e.config=null,e.available=!1):(e.parseConfig(a),e.available=!0),t()})})},r.prototype.readData=function(){var t=this;return t.ready=!1,n(function(e,n){if(t.available){var a=t.getValuesFile();d3.text(a,function(i,o){i?n("File not found: "+a):(t.parseCSV(o),t.resetBounds(),t.timeSteps=t.computeTimeSteps(),t.ready=!0,e())})}else n("No data available")})},r.prototype.parseConfig=function(t){t.Version||(t.Version=1),t.Version<2&&(t.NumberOfCoordinates=2),this.config=t},r.prototype.parseCSV=function(t){var e,n=this;this.flatArray=[],this.Data=d3.csv.parseRows(t,function(t){for(var a=[],i=0;i<n.config.GridHeight;i++){var o=+t[i],r=+t[n.config.GridHeight+i];if(e=n.config.NumberOfCoordinates>2?+t[2*n.config.GridHeight+i]:-.5,isNaN(o)||isNaN(r)||isNaN(e))a.push(null);else{for(var s=[],l=!1,c=0;c<n.config.Timesteps;c++){for(var u=[],h=0;h<n.config.NumberOfValues;h++){var d=+t[(n.config.NumberOfCoordinates+h*n.config.Timesteps+c)*n.config.GridHeight+i];isNaN(d)&&(l=!0),u.push(d)}1===n.config.NumberOfValues&&(u=u[0]),s.push(u)}if(l)a.push(null);else{var p={x:o,y:r,z:e,values:s};n.flatArray.push(p),a.push(p)}}}return a})},r.prototype.resetBounds=function(){this.xExtent=d3.extent(this.flatArray,function(t){return t.x}),this.yExtent=d3.extent(this.flatArray,function(t){return t.y}),this.zExtent=d3.extent(this.flatArray,function(t){return t.z});var t=this.valueAccessor,e=d3.min(this.flatArray,function(e){return d3.min(e.values,t)}),n=d3.max(this.flatArray,function(e){return d3.max(e.values,t)});if(this.valueExtent=[e,n],this.cropPercentile>0){var a=[].concat.apply([],this.flatArray.map(function(e){return e.values.map(t)}));this.scaleExtent=[i.percentile(a,this.cropPercentile),i.percentile(a,1-this.cropPercentile)]}else this.scaleExtent=this.valueExtent},r.prototype.computeTimeSteps=function(){for(var t=[],e=this.flatArray[0].values.length,n=this.timeSelection,i=a.firstDayOfWeek(n.week,n.year),o=0;o<e;o++){var r=moment(i).add(o*n.interval,"minutes");t.push(r)}return t},r.prototype.withTimeSteps=function(t){for(var e=Math.min(t.length,this.timeSteps.length),n=[],a=0;a<e;a++)n.push({date:this.timeSteps[a],value:t[a]});return n},r.prototype.getValuesFile=function(n){var a=this.timeSelection;if(null===a)return"";var i=""!==this.suffix?"_"+this.suffix:"";if(a.needNetcdf&&!n&&""===i){var o="data"===a.folder?"geneva":a.folder.slice(5);return e+"/week/"+a.week+"/"+a.year+"/"+o+"/"+this.fieldName+"/"+a.depth}return t+a.folder+"/"+a.year+"/"+this.fieldName+"/data_week"+a.week+i+".csv"},r.prototype.getMinimapSrc=function(){return""===this.suffix||null===this.timeSelection?"":t+this.timeSelection.folder+"/"+this.suffix+".png"},r.prototype.getLakeOptions=function(){var e=t+this.timeSelection.folder+"/options.json",a=this.timeSelection;return n(function(t,n){null===a&&n("No options found."),d3.json(e,function(a,i){a?n("Error retrieving lake options. Url: "+e+". Error: "+a):t(i)})})},r.prototype.getGlobalOptions=function(){var e=t+"/options.json";return n(function(t,n){d3.json(e,function(a,i){a?n("Error retrieving global options. Url: "+e+". Error: "+a):t(i)})})},r.prototype.parseDataCSV=function(t){let e=[];d3.csv.parseRows(t,function(t){e.push(t.slice(1))});let n=[];var a=/\(([^,)]+), ([^)]+)\)/;for(let t=0;t<e[0].length;t++){let r=e[1][t];var i=a.exec(r);r=i?o.norm([i[1],i[2]]):+r;let s={date:moment(e[0][t],"DD/MM/YYY HH:mm"),value:r};if(e.length>3){let n=e[2][t];n=(i=a.exec(n))?o.norm([i[1],i[2]]):+n,s.min_value=n;let r=e[3][t];r=(i=a.exec(r))?o.norm([i[1],i[2]]):+r,s.max_value=r}n.push(s)}return n},r.prototype.buildDataUrl=function(t){var n=this.timeSelection;if(null===n)return"";var i="data"===n.folder?"geneva":n.folder.slice(5),o=`${e}/range/coordinates/${t.x}/${t.y}/${i}/${this.fieldName}/${+a.firstDayOfWeek(n.week,n.year)}/${+a.lastDayOfWeek(n.week,n.year)}`;return t.z&&(o=`${o}/${Math.abs(t.z)}`),o},r.prototype.getDataAtPoint=function(t){var e=this;return n(function(n,a){var i=e.buildDataUrl(t);d3.text(i,function(t,o){t?a("url not found: "+i):n(e.parseDataCSV(o))})})},r}]),angular.module("meteolakesApp").factory("Time",function(){return{tIndex:0,nSteps:10080,increase:function(t){t?(this.tIndex++,this.tIndex>=this.nSteps&&(this.tIndex=0)):this.tIndex=Math.min(this.nSteps-1,this.tIndex+1)},decrease:function(){this.tIndex=Math.max(0,this.tIndex-1)},moveToEnd:function(){this.tIndex=this.nSteps-1}}}),angular.module("meteolakesApp").service("Util",function(){this.closest=function(t,e,n){var a,i,o=Number.MAX_VALUE;return t.forEach(function(t,n){var r=Math.abs(t-e);r<o&&(o=r,a=t,i=n)}),n?i:a},this.norm=function(t){return 2===t.length?Math.sqrt(t[0]*t[0]+t[1]*t[1]):t}}),function(t){var e,n;if("function"==typeof define&&define.amd)define(["leaflet","proj4"],t);else if("object"==typeof module&&"object"==typeof module.exports)e=require("leaflet"),n=require("proj4"),module.exports=t(e,n);else{if(void 0===window.L||void 0===window.proj4)throw"Leaflet and proj4 must be loaded first";t(window.L,window.proj4)}}(function(t,e){return t.Proj={},t.Proj._isProj4Obj=function(t){return void 0!==t.inverse&&void 0!==t.forward},t.Proj.ScaleDependantTransformation=function(t){this.scaleTransforms=t},t.Proj.ScaleDependantTransformation.prototype.transform=function(t,e){return this.scaleTransforms[e].transform(t,e)},t.Proj.ScaleDependantTransformation.prototype.untransform=function(t,e){return this.scaleTransforms[e].untransform(t,e)},t.Proj.Projection=t.Class.extend({initialize:function(n,a){if(t.Proj._isProj4Obj(n))this._proj=n;else{var i=n;if(a)e.defs(i,a);else if(void 0===e.defs[i]){var o=i.split(":");if(o.length>3&&(i=o[o.length-3]+":"+o[o.length-1]),void 0===e.defs[i])throw"No projection definition for code "+i}this._proj=e(i)}},project:function(e){var n=this._proj.forward([e.lng,e.lat]);return new t.Point(n[0],n[1])},unproject:function(e,n){var a=this._proj.inverse([e.x,e.y]);return new t.LatLng(a[1],a[0],n)}}),t.Proj.CRS=t.Class.extend({includes:t.CRS,options:{transformation:new t.Transformation(1,0,-1,0)},initialize:function(e,n,a){var i,o,r,s;if(t.Proj._isProj4Obj(e)?(i=(o=e).srsCode,s=n||{},this.projection=new t.Proj.Projection(o)):(i=e,r=n,s=a||{},this.projection=new t.Proj.Projection(i,r)),t.Util.setOptions(this,s),this.code=i,this.transformation=this.options.transformation,this.options.origin&&(this.transformation=new t.Transformation(1,-this.options.origin[0],-1,this.options.origin[1])),this.options.scales)this._scales=this.options.scales;else if(this.options.resolutions){this._scales=[];for(var l=this.options.resolutions.length-1;l>=0;l--)this.options.resolutions[l]&&(this._scales[l]=1/this.options.resolutions[l])}},scale:function(t){var e,n=Math.floor(t);return t===n?this._scales[t]:(e=this._scales[n])+(this._scales[n+1]-e)*(t-n)},getSize:function(e){var n,a,i,o=this.options.bounds;return o?(n=this.scale(e),a=this.transformation.transform(o.min,n),i=this.transformation.transform(o.max,n),t.point(Math.abs(i.x-a.x),Math.abs(i.y-a.y))):(n=256*Math.pow(2,e),t.point(n,n))}}),t.Proj.CRS.TMS=t.Proj.CRS.extend({options:{tileSize:256},initialize:function(e,n,a,i){var o,r,s,l,c;t.Proj._isProj4Obj(e)?(s=e,l=n,(c=a||{}).origin=[l[0],l[3]],t.Proj.CRS.prototype.initialize.call(this,s,c)):(o=e,r=n,l=a,(c=i||{}).origin=[l[0],l[3]],t.Proj.CRS.prototype.initialize.call(this,o,r,c)),this.projectedBounds=l,this._sizes=this._calculateSizes()},_calculateSizes:function(){var e,n,a,i,o=[],r=this.projectedBounds;for(n=this._scales.length-1;n>=0;n--)this._scales[n]&&(e=this.options.tileSize/this._scales[n],a=Math.ceil(parseFloat((r[2]-r[0])/e).toPrecision(3))*e*this._scales[n],i=Math.ceil(parseFloat((r[3]-r[1])/e).toPrecision(3))*e*this._scales[n],o[n]=t.point(a,i));return o},getSize:function(t){return this._sizes[t]}}),t.Proj.TileLayer={},t.Proj.TileLayer.TMS=t.TileLayer.extend({options:{continuousWorld:!0},initialize:function(e,n,a){var i,o,r,s,l=!0;if(!(n instanceof t.Proj.CRS.TMS))throw"CRS is not L.Proj.CRS.TMS.";for(t.TileLayer.prototype.initialize.call(this,e,a),this.options.tms=!1,this.crs=n,r=this.crs.projectedBounds,s=this.options.minZoom;s<this.options.maxZoom&&l;s++){var c=(r[3]-r[1])/this._projectedTileSize(s);l=Math.abs(c-Math.round(c))>.001}if(!l){for(i={},s=this.options.minZoom;s<this.options.maxZoom;s++)o=r[1]+Math.ceil((r[3]-r[1])/this._projectedTileSize(s))*this._projectedTileSize(s),i[this.crs.scale(s)]=new t.Transformation(1,-r[0],-1,o);this.crs=new t.Proj.CRS.TMS(this.crs.projection._proj,r,this.crs.options),this.crs.transformation=new t.Proj.ScaleDependantTransformation(i)}},getTileUrl:function(e){var n=this._map.getZoom(),a=Math.ceil((this.crs.projectedBounds[3]-this.crs.projectedBounds[1])/this._projectedTileSize(n));return t.Util.template(this._url,t.Util.extend({s:this._getSubdomain(e),z:this._getZoomForUrl(),x:e.x,y:a-e.y-1},this.options))},_projectedTileSize:function(t){return this.options.tileSize/this.crs.scale(t)}}),t.Proj.GeoJSON=t.GeoJSON.extend({initialize:function(e,n){this._callLevel=0,t.GeoJSON.prototype.initialize.call(this,null,n),e&&this.addData(e)},addData:function(e){var n;e&&(e.crs&&"name"===e.crs.type?n=new t.Proj.CRS(e.crs.properties.name):e.crs&&e.crs.type&&(n=new t.Proj.CRS(e.crs.type+":"+e.crs.properties.code)),void 0!==n&&(this.options.coordsToLatLng=function(e){var a=t.point(e[0],e[1]);return n.projection.unproject(a)})),this._callLevel++;try{t.GeoJSON.prototype.addData.call(this,e)}finally{this._callLevel--,0===this._callLevel&&delete this.options.coordsToLatLng}}}),t.Proj.geoJson=function(e,n){return new t.Proj.GeoJSON(e,n)},t.Proj.ImageOverlay=t.ImageOverlay.extend({initialize:function(e,n,a){t.ImageOverlay.prototype.initialize.call(this,e,null,a),this._projBounds=n},_animateZoom:function(e){var n=t.point(this._projBounds.min.x,this._projBounds.max.y),a=t.point(this._projBounds.max.x,this._projBounds.min.y),i=this._projectedToNewLayerPoint(n,e.zoom,e.center),o=this._projectedToNewLayerPoint(a,e.zoom,e.center).subtract(i),r=i.add(o._multiplyBy((1-1/e.scale)/2));this._image.style[t.DomUtil.TRANSFORM]=t.DomUtil.getTranslateString(r)+" scale("+this._map.getZoomScale(e.zoom)+") "},_reset:function(){var e=this._map.getZoom(),n=this._map.getPixelOrigin(),a=t.bounds(this._transform(this._projBounds.min,e)._subtract(n),this._transform(this._projBounds.max,e)._subtract(n)),i=a.getSize(),o=this._image;t.DomUtil.setPosition(o,a.min),o.style.width=i.x+"px",o.style.height=i.y+"px"},_projectedToNewLayerPoint:function(t,e,n){var a=this._map._getNewTopLeftPoint(n,e).add(this._map._getMapPanePos());return this._transform(t,e)._subtract(a)},_transform:function(t,e){var n=this._map.options.crs,a=n.transformation,i=n.scale(e);return a.transform(t,i)}}),t.Proj.imageOverlay=function(e,n,a){return new t.Proj.ImageOverlay(e,n,a)},void 0!==t.CRS&&(t.CRS.proj4js=function(e,n,a,i){return i=i||{},a&&(i.transformation=a),new t.Proj.CRS(e,n,i)}),t.Proj}),angular.module("rbush").factory("knn",["TinyQueue",function(t){function e(t,e){return t.dist-e.dist}function n(t,e,n){return t<e?e-t:t<=n?0:t-n}return function(a,i,o,r){for(var s,l,c,u,h,d,p=a.data,f=[],m=a.toBBox,v=new t(null,e);p;){for(s=0;s<p.children.length;s++)l=p.children[s],v.push({node:l,isItem:p.leaf,dist:(c=i,u=p.leaf?m(l):l.bbox,h=void 0,d=void 0,h=n(c[0],u[0],u[2]),d=n(c[1],u[1],u[3]),h*h+d*d)});for(;v.length&&v.peek().isItem;){var g=v.pop().node;if(r&&!r(g)||f.push(g),f.length===o)return f}(p=v.pop())&&(p=p.node)}return f}}]),angular.module("rbush").factory("rbush",function(){function t(e,n){if(!(this instanceof t))return new t(e,n);this._maxEntries=Math.max(4,e||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),n&&this._initFormat(n),this.clear()}function e(t,e){t.bbox=n(t,0,t.children.length,e)}function n(t,e,n,o){for(var r,s=a(),l=e;l<n;l++)r=t.children[l],i(s,t.leaf?o(r):r.bbox);return s}function a(){return[1/0,1/0,-1/0,-1/0]}function i(t,e){return t[0]=Math.min(t[0],e[0]),t[1]=Math.min(t[1],e[1]),t[2]=Math.max(t[2],e[2]),t[3]=Math.max(t[3],e[3]),t}function o(t,e){return t.bbox[0]-e.bbox[0]}function r(t,e){return t.bbox[1]-e.bbox[1]}function s(t){return(t[2]-t[0])*(t[3]-t[1])}function l(t){return t[2]-t[0]+(t[3]-t[1])}function c(t,e){return t[0]<=e[0]&&t[1]<=e[1]&&e[2]<=t[2]&&e[3]<=t[3]}function u(t,e){return e[0]<=t[2]&&e[1]<=t[3]&&e[2]>=t[0]&&e[3]>=t[1]}function h(t,e,n,a,i){for(var o,r=[e,n];r.length;)(n=r.pop())-(e=r.pop())<=a||(d(t,e,n,o=e+Math.ceil((n-e)/a/2)*a,i),r.push(e,o,o,n))}function d(t,e,n,a,i){for(var o,r,s,l,c,u,h;n>e;){for(n-e>600&&(o=n-e+1,r=a-e+1,s=Math.log(o),l=.5*Math.exp(2*s/3),c=.5*Math.sqrt(s*l*(o-l)/o)*(r-o/2<0?-1:1),d(t,Math.max(e,Math.floor(a-r*l/o+c)),Math.min(n,Math.floor(a+(o-r)*l/o+c)),a,i)),u=t[a],r=e,h=n,p(t,e,a),i(t[n],u)>0&&p(t,e,n);r<h;){for(p(t,r,h),r++,h--;i(t[r],u)<0;)r++;for(;i(t[h],u)>0;)h--}0===i(t[e],u)?p(t,e,h):p(t,++h,n),h<=a&&(e=h+1),a<=h&&(n=h-1)}}function p(t,e,n){var a=t[e];t[e]=t[n],t[n]=a}return t.prototype={all:function(){return this._all(this.data,[])},search:function(t){var e=this.data,n=[],a=this.toBBox;if(!u(t,e.bbox))return n;for(var i,o,r,s,l=[];e;){for(i=0,o=e.children.length;i<o;i++)r=e.children[i],u(t,s=e.leaf?a(r):r.bbox)&&(e.leaf?n.push(r):c(t,s)?this._all(r,n):l.push(r));e=l.pop()}return n},collides:function(t){var e=this.data,n=this.toBBox;if(!u(t,e.bbox))return!1;for(var a,i,o,r,s=[];e;){for(a=0,i=e.children.length;a<i;a++)if(o=e.children[a],u(t,r=e.leaf?n(o):o.bbox)){if(e.leaf||c(t,r))return!0;s.push(o)}e=s.pop()}return!1},load:function(t){if(!t||!t.length)return this;if(t.length<this._minEntries){for(var e=0,n=t.length;e<n;e++)this.insert(t[e]);return this}var a=this._build(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===a.height)this._splitRoot(this.data,a);else{if(this.data.height<a.height){var i=this.data;this.data=a,a=i}this._insert(a,this.data.height-a.height-1,!0)}else this.data=a;return this},insert:function(t){return t&&this._insert(t,this.data.height-1),this},clear:function(){return this.data={children:[],height:1,bbox:a(),leaf:!0},this},remove:function(t){if(!t)return this;for(var e,n,a,i,o=this.data,r=this.toBBox(t),s=[],l=[];o||s.length;){if(o||(o=s.pop(),n=s[s.length-1],e=l.pop(),i=!0),o.leaf&&-1!==(a=o.children.indexOf(t)))return o.children.splice(a,1),s.push(o),this._condense(s),this;i||o.leaf||!c(o.bbox,r)?n?(e++,o=n.children[e],i=!1):o=null:(s.push(o),l.push(e),e=0,n=o,o=o.children[0])}return this},toBBox:function(t){return t},compareMinX:function(t,e){return t[0]-e[0]},compareMinY:function(t,e){return t[1]-e[1]},toJSON:function(){return this.data},fromJSON:function(t){return this.data=t,this},_all:function(t,e){for(var n=[];t;)t.leaf?e.push.apply(e,t.children):n.push.apply(n,t.children),t=n.pop();return e},_build:function(t,n,a,i){var o,r=a-n+1,s=this._maxEntries;if(r<=s)return e(o={children:t.slice(n,a+1),height:1,bbox:null,leaf:!0},this.toBBox),o;i||(i=Math.ceil(Math.log(r)/Math.log(s)),s=Math.ceil(r/Math.pow(s,i-1))),o={children:[],height:i,bbox:null,leaf:!1};var l,c,u,d,p=Math.ceil(r/s),f=p*Math.ceil(Math.sqrt(s));for(h(t,n,a,f,this.compareMinX),l=n;l<=a;l+=f)for(h(t,l,u=Math.min(l+f-1,a),p,this.compareMinY),c=l;c<=u;c+=p)d=Math.min(c+p-1,u),o.children.push(this._build(t,c,d,i-1));return e(o,this.toBBox),o},_chooseSubtree:function(t,e,n,a){for(var i,o,r,l,c,u,h,d,p,f;a.push(e),!e.leaf&&a.length-1!==n;){for(h=d=1/0,i=0,o=e.children.length;i<o;i++)c=s((r=e.children[i]).bbox),p=t,f=r.bbox,(u=(Math.max(f[2],p[2])-Math.min(f[0],p[0]))*(Math.max(f[3],p[3])-Math.min(f[1],p[1]))-c)<d?(d=u,h=c<h?c:h,l=r):u===d&&c<h&&(h=c,l=r);e=l}return e},_insert:function(t,e,n){var a=this.toBBox,o=n?t.bbox:a(t),r=[],s=this._chooseSubtree(o,this.data,e,r);for(s.children.push(t),i(s.bbox,o);e>=0&&r[e].children.length>this._maxEntries;)this._split(r,e),e--;this._adjustParentBBoxes(o,r,e)},_split:function(t,n){var a=t[n],i=a.children.length,o=this._minEntries;this._chooseSplitAxis(a,o,i);var r=this._chooseSplitIndex(a,o,i),s={children:a.children.splice(r,a.children.length-r),height:a.height,bbox:null,leaf:!1};a.leaf&&(s.leaf=!0),e(a,this.toBBox),e(s,this.toBBox),n?t[n-1].children.push(s):this._splitRoot(a,s)},_splitRoot:function(t,n){this.data={children:[t,n],height:t.height+1,bbox:null,leaf:!1},e(this.data,this.toBBox)},_chooseSplitIndex:function(t,e,a){var i,o,r,l,c,u,h,d,p,f,m,v,g,y;for(u=h=1/0,i=e;i<=a-e;i++)o=n(t,0,i,this.toBBox),r=n(t,i,a,this.toBBox),p=o,f=r,m=void 0,v=void 0,g=void 0,y=void 0,m=Math.max(p[0],f[0]),v=Math.max(p[1],f[1]),g=Math.min(p[2],f[2]),y=Math.min(p[3],f[3]),l=Math.max(0,g-m)*Math.max(0,y-v),c=s(o)+s(r),l<u?(u=l,d=i,h=c<h?c:h):l===u&&c<h&&(h=c,d=i);return d},_chooseSplitAxis:function(t,e,n){var a=t.leaf?this.compareMinX:o,i=t.leaf?this.compareMinY:r;this._allDistMargin(t,e,n,a)<this._allDistMargin(t,e,n,i)&&t.children.sort(a)},_allDistMargin:function(t,e,a,o){t.children.sort(o);var r,s,c=this.toBBox,u=n(t,0,e,c),h=n(t,a-e,a,c),d=l(u)+l(h);for(r=e;r<a-e;r++)s=t.children[r],i(u,t.leaf?c(s):s.bbox),d+=l(u);for(r=a-e-1;r>=e;r--)s=t.children[r],i(h,t.leaf?c(s):s.bbox),d+=l(h);return d},_adjustParentBBoxes:function(t,e,n){for(var a=n;a>=0;a--)i(e[a].bbox,t)},_condense:function(t){for(var n,a=t.length-1;a>=0;a--)0===t[a].children.length?a>0?(n=t[a-1].children).splice(n.indexOf(t[a]),1):this.clear():e(t[a],this.toBBox)},_initFormat:function(t){var e=["return a"," - b",";"];this.compareMinX=new Function("a","b",e.join(t[0])),this.compareMinY=new Function("a","b",e.join(t[1])),this.toBBox=new Function("a","return [a"+t.join(", a")+"];")}},t}),angular.module("rbush").factory("TinyQueue",function(){function t(n,a){if(!(this instanceof t))return new t(n,a);if(this.data=n||[],this.length=this.data.length,this.compare=a||e,n)for(var i=Math.floor(this.length/2);i>=0;i--)this._down(i)}function e(t,e){return t<e?-1:t>e?1:0}function n(t,e,n){var a=t[e];t[e]=t[n],t[n]=a}return t.prototype={push:function(t){this.data.push(t),this.length++,this._up(this.length-1)},pop:function(){var t=this.data[0];return this.data[0]=this.data[this.length-1],this.length--,this.data.pop(),this._down(0),t},peek:function(){return this.data[0]},_up:function(t){for(var e=this.data,a=this.compare;t>0;){var i=Math.floor((t-1)/2);if(!(a(e[t],e[i])<0))break;n(e,i,t),t=i}},_down:function(t){for(var e=this.data,a=this.compare,i=this.length;;){var o=2*t+1,r=o+1,s=t;if(o<i&&a(e[o],e[s])<0&&(s=o),r<i&&a(e[r],e[s])<0&&(s=r),s===t)return;n(e,s,t),t=s}}},t}),angular.module("stats").service("stats",function(){this.isNumber=function(t){return!isNaN(parseFloat(t))&&isFinite(t)},this.numbers=function(t){var e=[];if(null==t)return e;for(var n=0;n<t.length;n++)this.isNumber(t[n])&&e.push(+t[n]);return e},this.nsort=function(t){return t.sort(function(t,e){return t-e})},this.sum=function(t){t=this.numbers(t);for(var e=0,n=0;n<t.length;n++)e+=t[n];return e},this.mean=function(t){return 0===(t=this.numbers(t)).length?NaN:this.sum(t)/t.length},this.median=function(t){if(0===(t=this.numbers(t)).length)return NaN;var e=t.length/2|0;return(t=this.nsort(t)).length%2?t[e]:(t[e-1]+t[e])/2},this.mode=function(t){if(0===(t=this.numbers(t)).length)return NaN;for(var e,n={},a=0;a<t.length;a++){var i=t[a],o=n[i]||0;o++,n[i]=o}var r=this.numbers(Object.keys(n).sort(function(t,e){return n[e]-n[t]}));if(e=r[0],n[r[1]]==n[e]){if(r.length==t.length)return t;var s=new Set([e]),l=n[e];for(a=1;a<r.length&&n[r[a]]==l;a++)s.add(r[a]);return s}return e},this.variance=function(t){t=this.numbers(t);for(var e=this.mean(t),n=[],a=0;a<t.length;a++)n.push(Math.pow(t[a]-e,2));return this.mean(n)},this.stdev=function(t){return Math.sqrt(this.variance(t))},this.percentile=function(t,e){if(0===(t=this.numbers(t)).length||null==e||e<0)return NaN;e>1&&(e=1);var n=(t=this.nsort(t)).length*e-.5;if((0|n)===n)return t[n];var a=0|n,i=n-a;return(1-i)*t[a]+i*t[Math.min(a+1,t.length-1)]}});